name: Global CI Pipeline

on:
  workflow_call:
    inputs:
      project_path:
        description: "Directory of the project (e.g. frontend, backend)"
        required: true
        type: string
      app_type:
        description: "Type of application (react, node, next, react-native, spring)"
        required: true
        type: string
      node_version:
        description: "Node version to use for build/checks"
        required: false
        type: string
        default: "18"

      build_env:
        description: "Build Environment (prod, dev, stage)"
        required: true
        type: string
      api_base_url:
        description: "API Base URL for React/Next builds"
        required: false
        type: string
      domain_with_path:
        description: "Whether domain includes a path prefix (used for BASE_PATH_ARG)"
        required: false
        type: boolean
        default: false
      build_args:
        description: "Additional docker build arguments"
        required: false
        type: string

jobs:
  build-and-push:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        if: ${{ inputs.app_type == 'react' || inputs.app_type == 'node' || inputs.app_type == 'next' || inputs.app_type == 'react-native' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}

      - name: Check NPM Audit
        if: ${{ inputs.app_type == 'react' || inputs.app_type == 'node' || inputs.app_type == 'next' || inputs.app_type == 'react-native' }}
        working-directory: ${{ inputs.project_path }}
        run: |
          if [ -f "package.json" ]; then
            npm audit || true
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Docker Tag Name
        id: generate-tag
        run: |
          # The format requested is: registry.k303.hostingbeta.com/ORG/REPONAME-project_path-branch:latest
          # github.repository is in the format ORG/REPONAME
          REPO=${{ github.repository }}
          # github.ref_name contains the branch name
          BRANCH=${{ github.ref_name }}
          PROJECT=${{ inputs.project_path }}

          # Replace slashes or special characters in branch or project path if needed, to keep typical tag formats clean
          # This creates something like 'ORG/REPO-frontend-main'
          IMAGE_TAG="registry.k303.hostingbeta.com/${REPO}-${PROJECT}-${BRANCH}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.project_path }}
          file: ${{ inputs.project_path }}/Dockerfile
          push: true
          tags: ${{ env.IMAGE_TAG }}:latest,${{ env.IMAGE_TAG }}:${{ github.run_number }}
          build-args: |
            BUILD_ENV=${{ inputs.build_env }}
            ${{ inputs.api_base_url != '' && format('REACT_APP_BASE_URL={0}', inputs.api_base_url) || '' }}
            ${{ inputs.api_base_url != '' && format('API_BASE_URL={0}', inputs.api_base_url) || '' }}
            ${{ inputs.domain_with_path && format('BASE_PATH_ARG={0}', inputs.project_path) || '' }}
            ${{ inputs.build_args }}
